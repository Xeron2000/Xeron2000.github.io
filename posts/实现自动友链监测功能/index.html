<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实现自动友链监测功能 - Su 素</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --meta-color: #a0a0a0;
            --link-color: #d0d0d0;
            --accent-color: #f0f0f0;
            --font-main: "Georgia", "Times New Roman", "Songti SC", "SimSun", serif;
            --font-mono: "Menlo", "Monaco", "Courier New", monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            line-height: 1.8;
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
            font-size: 16px;
        }

         
        header {
            margin-bottom: 60px;
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .site-title {
            font-size: 1.5em;
            font-weight: bold;
            text-decoration: none;
            color: var(--text-color);
            letter-spacing: 1px;
        }

        nav a {
            margin-left: 20px;
            text-decoration: none;
            color: var(--meta-color);
            font-size: 0.9em;
            cursor: pointer;
        }

        nav a:hover, nav a.active {
            color: var(--text-color);
            text-decoration: underline;
        }

         
        a {
            color: var(--link-color);
            text-decoration: underline;
            text-decoration-thickness: 1px;
            text-underline-offset: 3px;
            transition: all 0.2s;
        }
        a:hover {
            background-color: rgba(208, 208, 208, 0.1);
        }

         
        .archive-list {
            list-style: none;
            padding: 0;
        }

        .archive-item {
            display: flex;
            align-items: baseline;
            margin-bottom: 16px;
            padding-bottom: 8px;
        }

        .archive-date {
            font-family: var(--font-mono);
            color: var(--meta-color);
            font-size: 0.85em;
            width: 110px;
            flex-shrink: 0;
        }

        .archive-title {
            font-weight: normal;
            text-decoration: none;
            cursor: pointer;
        }

         
        .post-header {
            margin-bottom: 40px;
            text-align: center;
        }

        .post-title {
            font-size: 2em;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .post-meta {
            font-family: var(--font-mono);
            color: var(--meta-color);
            font-size: 0.9em;
        }

        .post-content {
            text-align: justify;
        }

        .post-content p {
            margin-bottom: 1.5em;
        }

        .post-content h2 {
            font-size: 1.4em;
            margin-top: 2em;
            margin-bottom: 1em;
        }

        .post-content blockquote {
            margin: 1.5em 0;
            padding: 1em 1.5em;
            background-color: rgba(255, 255, 255, 0.05);
            font-style: italic;
            color: var(--meta-color);
        }

        .post-content blockquote p {
            margin-bottom: 0;
        }

         
        .about-section {
            margin-bottom: 50px;
        }

        .friends-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
        }

        .friend-item {
            margin-bottom: 15px;
        }

        .friend-item a {
            font-weight: bold;
            margin-right: 10px;
        }

        .friend-desc {
            color: var(--meta-color);
            font-size: 0.9em;
        }

         
        footer {
            margin-top: 80px;
            padding-top: 20px;
            text-align: center;
            font-size: 0.8em;
            color: var(--meta-color);
            font-family: var(--font-mono);
        }

         
        .post-content pre,
        .post-content .highlight {
            position: relative;
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 16px;
            margin: 1.5em 0;
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 0.9em;
            line-height: 1.5;
        }

        .post-content pre code,
        .post-content .highlight pre {
            display: block;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            color: var(--text-color);
            background: none;
            padding: 0;
            margin: 0;
        }

         
        .post-content .highlight pre {
            background: none !important;
            color: var(--text-color) !important;
        }

        .post-content .highlight pre code span {
            display: inline;
        }

        .post-content pre:hover .copy-button {
            opacity: 1;
        }

        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.8em;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            font-family: var(--font-mono);
        }

        .copy-button:hover {
            background-color: #5a6268;
        }

        .copy-button.copied {
            background-color: #28a745;
        }

         
        .post-content :not(pre) > code {
            background-color: #404040;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 0.9em;
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <header>
    <a href="https://blog.040304.xyz/" class="site-title">Su 素</a>
    <nav>
        <a href="https://blog.040304.xyz/">首页</a>
        <a href="https://blog.040304.xyz/about/">关于 & 友链</a>
    </nav>
</header>

    <main id="app">
        
<article>
    <div class="post-header">
        <h1 class="post-title">实现自动友链监测功能</h1>
        <div class="post-meta">发布于 2025-08-24</div>
    </div>
    <div class="post-content">
        <h2 id="起因">起因</h2>
<p>最近想给博客的友链添加一个自动监测功能，能够显示每个友链的在线状态。这样访问者就能知道哪些朋友的网站还能正常访问</p>
<h2 id="实现过程">实现过程</h2>
<h3 id="1-定义类型接口">1. 定义类型接口</h3>
<p>首先创建类型定义文件 <code>types/linkStatus.ts</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">FriendLink</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>: <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">title</span>: <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">avatar</span>: <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">link</span>: <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">status?</span>: <span style="color:#66d9ef">LinkStatus</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastChecked?</span>: <span style="color:#66d9ef">Date</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">LinkStatus</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">isOnline</span>: <span style="color:#66d9ef">boolean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statusCode?</span>: <span style="color:#66d9ef">number</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">responseTime?</span>: <span style="color:#66d9ef">number</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">error?</span>: <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="2-实现链接检查服务">2. 实现链接检查服务</h3>
<p>创建 <code>utils/simpleLinkChecker.ts</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleLinkChecker</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">checkLinks</span>(<span style="color:#a6e22e">links</span>: <span style="color:#66d9ef">FriendLink</span>[])<span style="color:#f92672">:</span> <span style="color:#a6e22e">Promise</span>&lt;<span style="color:#f92672">FriendLink</span><span style="color:#960050;background-color:#1e0010">[]</span>&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">results</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">Promise</span>.<span style="color:#a6e22e">allSettled</span>(<span style="color:#a6e22e">links</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">link</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checkSingleLink</span>(<span style="color:#a6e22e">link</span>)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">links</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">link</span>, <span style="color:#a6e22e">index</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">results</span>[<span style="color:#a6e22e">index</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;fulfilled&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                    ...<span style="color:#a6e22e">link</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">status</span>: <span style="color:#66d9ef">result.value.status</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">lastChecked</span>: <span style="color:#66d9ef">result.value.timestamp</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// If failed, mark as offline
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>                ...<span style="color:#a6e22e">link</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">isOnline</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">error</span>: <span style="color:#66d9ef">result.status</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;rejected&#39;</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">reason</span>.<span style="color:#a6e22e">message</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Check failed&#39;</span>
</span></span><span style="display:flex;"><span>                },
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">lastChecked</span>: <span style="color:#66d9ef">new</span> Date()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        })
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="遇到的坑">遇到的坑</h2>
<h3 id="cors-问题">CORS 问题</h3>
<p>第一个大坑是浏览器的 CORS 政策。最初我尝试直接发送 <code>HEAD</code> 请求：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">link</span>.<span style="color:#a6e22e">link</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;HEAD&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mode</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;cors&#39;</span>
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>但大多数网站都不会返回 CORS 头，导致请求失败。解决方案是：</p>
<ol>
<li>先尝试 <code>mode: 'cors'</code></li>
<li>如果失败，改用 <code>mode: 'no-cors'</code></li>
<li>作为后备，使用 <code>Image</code> 对象加载</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">// Try with ping approach using Image
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Image</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">await</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Promise</span>((<span style="color:#a6e22e">resolve</span>, <span style="color:#a6e22e">reject</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">resolve</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">onerror</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">reject</span>(<span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">&#39;Image load failed&#39;</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img</span>.<span style="color:#a6e22e">src</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">link</span>.<span style="color:#a6e22e">link</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;?t=&#39;</span> <span style="color:#f92672">+</span> Date.<span style="color:#a6e22e">now</span>()
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h3 id="vue-列表渲染问题">Vue 列表渲染问题</h3>
<p>在实现排序功能时，遇到了一个奇怪的问题：排序后不同的友链显示了相同的头像。这是因为 Vue 的虚拟 DOM 复用机制</p>
<p><strong>问题代码</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vue" data-lang="vue"><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#f92672">v-for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(friend, index) in displayLinks&#34; :key=&#34;index&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span></code></pre></div><p><strong>解决方案</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vue" data-lang="vue"><span style="display:flex;"><span>&lt;<span style="color:#f92672">div</span> <span style="color:#f92672">v-for</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;(friend, index) in displayLinks&#34; :key=&#34;friend.link&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span></code></pre></div><p>使用 <code>friend.link</code> 作为 key，确保每个元素都有唯一的标识</p>
<h3 id="缓存策略">缓存策略</h3>
<p>为了避免每次页面加载都检查所有链接，实现了缓存机制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">// Save to localStorage
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">localStorage</span>.<span style="color:#a6e22e">setItem</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;friendLinksStatus&#39;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">links</span>: <span style="color:#66d9ef">results</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">timestamp</span>: <span style="color:#66d9ef">Date.now</span>()
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Check if cache is expired (24 hours)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">hoursSinceLastCheck</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">now</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">lastCheck</span>) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1000</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">hoursSinceLastCheck</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">24</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">checkLinksStatus</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="最终效果">最终效果</h2>
<ol>
<li><strong>自动排序</strong>：在线的友链自动排在前面</li>
<li><strong>状态显示</strong>：右上角显示 &ldquo;ONLINE&rdquo; 或 &ldquo;OFFLINE&rdquo; 标签</li>
<li><strong>每日更新</strong>：每 24 小时自动检查一次</li>
<li><strong>本地缓存</strong>：使用 localStorage 缓存结果</li>
</ol>

    </div>
    <div style="margin-top:50px; text-align:center;">
        <a href="https://blog.040304.xyz/" style="cursor:pointer; font-family:var(--font-mono)">← 返回列表</a>
    </div>
</article>

    </main>

    <footer>
    &copy; 2025 Su 素. Text Only.
</footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const codeBlocks = document.querySelectorAll('.post-content pre, .post-content .highlight');

            codeBlocks.forEach(function(block) {
                
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = '复制';

                
                block.style.position = 'relative';
                block.appendChild(copyButton);

                
                copyButton.addEventListener('click', function() {
                    const codeElement = block.querySelector('code') || block.querySelector('pre');
                    const text = codeElement.textContent || codeElement.innerText;

                    
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(text).then(function() {
                            showCopySuccess(copyButton);
                        }).catch(function() {
                            fallbackCopy(text, copyButton);
                        });
                    } else {
                        
                        fallbackCopy(text, copyButton);
                    }
                });
            });

            function showCopySuccess(button) {
                const originalText = button.textContent;
                button.textContent = '已复制';
                button.classList.add('copied');

                setTimeout(function() {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }

            function fallbackCopy(text, button) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                    showCopySuccess(button);
                } catch (err) {
                    console.error('复制失败:', err);
                    button.textContent = '复制失败';
                    setTimeout(function() {
                        button.textContent = '复制';
                    }, 2000);
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        });
    </script>
</body>
</html>